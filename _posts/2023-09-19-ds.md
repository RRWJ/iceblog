---
layout: post
title: distribute system
date: 2023-09-19
tags: [Spring]
comments: false
---
一、背景
Kubernetes：
早期是以作为微服务的分布式部署运行系统为主，整体来说，Kubernetes的大概流程如下：
部署一个微服务的时候，设定微服务“目标”状态之后（内存/CPU/POD实例数）Scheduler分配POD作为一个运行部署单元，Controllers时刻监控各种POD的“实际”状态，一旦状态不符合，则将微服务恢复到目标状态。
这是一种常见的模式，通过设定目标状态（Target State），感知(Monitor)当前状态(Current State)，一旦当前状态和目标状态不符， Controller调节系统以使系统达到该状态。
目前使用的很多中间件，当目标状态和当前状态不符（系统监控异常，系统需要补丁，系统需要备份），实际上是通过人力（SRE或者业务团队)把系统从当前状态调节到目标状态。

原生的Kubernetes对无状态的微服务实现了完善的控制器（Controller），由于微服务无状态，所以Kubernetes可以统一不同微服务的安装，升级，扩容，故障处理等等。
但是由于中间件有状态，原生的Kubernetes控制器难于完成中间件的控制，所以Kubernetes提供了一种扩展机制: Operator。
Operator允许定义各种自定义资源（Custom Resources）和自定义控制面程序，从而对这些自定义资源完成客户化的控制。
目前各个公司和社区纷纷利用该技术将各种中间件基于Kubernetes容器化技术 服务化。
MAS架构下，也是将各种中间件定义为资源，然后通过控制器实现对各种中间件的安装部署，升级，故障自愈，扩容等。
从生态来看，Kubernetes的社区发展快、生态更加活跃，自身具有灵活、强大的弹性资源调度/编排能力。

二、Grid服务化
一方面，分布式系统通常采用冗余、基于负载均衡的scale-out方式，来保证系统的可用性和可扩展性。冗余的常见的方式如主备，双活，多活等方式，负载均衡常用方式如4层负载均衡，7层负载均衡。
另一方面，在大规模分布式系统里，故障一直都在发生（“Everything fails all the time.”–Werner Vogels）。一种常见的减少爆炸半径的方式是基于AZ和Region的划分，它基于“物理区域"维度来减小爆炸半径，AZ内故障不会波及到其他AZ和Region，
Region内故障不会波及到其他Region和其内的AZ。但是这种方式划分故障半径的最小的粒度为AZ，同时也不支持从业务维度（如按租户）来划分爆炸半径。因此，我们需要一种即能支持更细粒度的爆炸半径划分维度，同时又能支持从业务角度来划分爆炸半径的维度。
Grid架构是将系统划分为多个功能相同的业务单元，每个Grid单元具备完整业务功能，同时构建一层薄的路由层，将业务请求按设定规则路由到固定的Grid处理，如按用户分配到固定的Grid处理，任何一个Grid故障仅影响路由到该Grid的用户，不影响其他用户。
同时基于Grid划分，可以增强系统的可扩展性。不同于传统的扩展模型，基于Grid架构的系统以Grid为单位进行扩容。
服务化GridRouter/Etcd 当前部署在管理区，仅限管理区服务使用

Grid/Etcd处于管理区M1层，但位于M0的kkei物理机上
MAS(Middleware As Service)的管理平台负责gridrouter/etcd自身的发放、扩散容、升级等运维操作，主要应用k8s的面向终态调谐机制。
管理面的中间件能力归一，统一以服务化的方式，为业务系统提供高可用的、高性能的、可扩展的、经济的中间件能力。 

管理面：
前端Console界面下发发放实例、扩缩容、升级指令，由后台API Service将请求转发给K8S Api server，进而转发给GridRouter/Etcd Operator处理相应的请求；

数据面（用户未对接网格）：
服务请求经过APIG下发，根据域名解析可以得到LVS对外的vip，将请求发送至LVS，LVS的vip映射到GridRouter的pod ip，LVS将请求再转发至GridRouter pod上，
GridRouter根据用户的域名，可以得知路由策略，并查到对应的路由信息，进而得知deck域名，将请求转发至deck。

数据面（用户对接网格）：
服务请求经过APIG下发，根据域名解析可以得到lvs对外的vip，将请求发送至LVS，LVS的vip映射到GridRouter的pod ip，LVS将请求再转发至GridRouter pod上，
GridRouter根据用户的域名，可以得知路由策略，并查到对应的路由信息，进而得知deck域名，GSLB域名解析得出LVS对外的vip，将请求下发给LVS，LVS转发至网格的Ingress，Ingress再进一步转发到目标deck。

三、Etcd服务化
业界实现阿里云Etcd服务化方案：https://segmentfault.com/a/1190000039820855

四、核心开发
1、编排框架 -- 状态机
Spring Statemachine：https://github.com/spring-projects/spring-statemachine
Squirrel Statemachine：https://github.com/hekailiang/squirrel
COLA Statemachine：https://github.com/alibaba/COLA/tree/master/cola-components/cola-component-statemachine

2、分布式锁 -- 基于开源框架shedlock
3、K8S统一建连能力&CRD的统一读写能力
  a.K8S统一建连能力，CRD SPEC和K8S自身的配置解耦。
  b.CRD的统一读写能力，根据CRD元数据文件建模生成Java类。
  c.基于CRD模型类封装业务方法，业务只需要指定特定参数即可。
  
